<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§ä¿¡æµç¨‹æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        .section h2 {
            color: #007bff;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0,123,255,0.3);
        }
        button {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .messages {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .message .timestamp {
            font-size: 12px;
            color: #666;
            float: right;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            margin: 0 5px;
            border-radius: 8px;
            background: #e9ecef;
            color: #6c757d;
            font-weight: bold;
        }
        .step.active {
            background: #007bff;
            color: white;
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .chat-history {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .chat-message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 15px;
            max-width: 70%;
        }
        .chat-message.self {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .chat-message.other {
            background: #e9ecef;
            color: #333;
        }
        .chat-message .sender {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
        }
        .chat-message .time {
            font-size: 11px;
            opacity: 0.7;
        }
        .match-list {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .match-item {
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        .match-item:hover {
            background: #e3f2fd;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.2);
        }
        .match-item.selected {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .match-title {
            font-weight: bold;
            font-size: 16px;
        }
        .match-score {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
        }
        .match-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .match-item.selected .match-description {
            color: #e9ecef;
        }
        .match-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        .match-status {
            display: flex;
            gap: 10px;
        }
        .status-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }
        .status-badge.liked {
            background: #dc3545;
            color: white;
        }
        .status-badge.chatroom {
            background: #17a2b8;
            color: white;
        }
        
        /* å®æ—¶èŠå¤©çª—å£æ ·å¼ */
        .chat-window {
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 0;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }
        .chat-window.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        .chat-header {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-status {
            font-size: 12px;
            opacity: 0.9;
        }
        .chat-messages {
            flex: 1;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }
        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #dee2e6;
            border-radius: 0 0 6px 6px;
        }
        .chat-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .chat-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 20px;
            resize: none;
            min-height: 40px;
            max-height: 100px;
        }
        .chat-input:focus {
            outline: none;
            border-color: #007bff;
        }
        .send-btn {
            width: auto;
            padding: 10px 20px;
            border-radius: 20px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin: 0;
        }
        .send-btn:hover {
            background: #0056b3;
        }
        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .real-chat-message {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .real-chat-message.sent {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .real-chat-message.received {
            background: #e9ecef;
            color: #333;
            margin-right: auto;
        }
        .real-chat-message .message-info {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }
        .real-chat-message.sent .message-info {
            text-align: right;
        }
        .empty-chat {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ ç§ä¿¡æµç¨‹æµ‹è¯•é¡µé¢</h1>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="section">
            <h2>ğŸ“¡ WebSocket è¿æ¥</h2>
            <div class="form-group">
                <label>ç”¨æˆ·ID:</label>
                <input type="number" id="userIdInput" placeholder="è¾“å…¥ä½ çš„ç”¨æˆ·ID" value="1">
            </div>
            <button id="connectBtn" onclick="connect()">è¿æ¥ WebSocket</button>
            <div id="connectionStatus" class="status info" style="display:none;">å‡†å¤‡è¿æ¥...</div>
        </div>

        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="section">
            <h2>ğŸ“‹ ç§ä¿¡æµç¨‹æ­¥éª¤</h2>
            <div class="step-indicator">
                <div class="step" id="step1">æ­¥éª¤1: è·å–/åˆ›å»ºèŠå¤©å®¤</div>
                <div class="step" id="step2">æ­¥éª¤2: è·å–èŠå¤©å†å²</div>
                <div class="step" id="step3">æ­¥éª¤3: å®Œæˆåˆå§‹åŒ–</div>
            </div>
        </div>

        <!-- åŒ¹é…åˆ—è¡¨æ˜¾ç¤º -->
        <div class="section" id="matchListSection" style="display:none;">
            <h2>ğŸ’• å¯ç”¨çš„åŒ¹é…åˆ—è¡¨</h2>
            <div id="matchList" class="match-list">
                <!-- åŒ¹é…åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
            <div class="form-group">
                <label>ç›®æ ‡ç”¨æˆ·ID:</label>
                <input type="number" id="targetUserIdInput" placeholder="è¾“å…¥ç›®æ ‡ç”¨æˆ·ID" value="2">
            </div>
            <div class="form-group">
                <label>åŒ¹é…ID:</label>
                <input type="number" id="matchIdInput" placeholder="è¾“å…¥åŒ¹é…ID" value="1">
            </div>
            <button id="startPrivateChatBtn" onclick="startPrivateChat()" disabled>å¯åŠ¨ç§ä¿¡æµç¨‹</button>
        </div>

        <!-- å®æ—¶æ¶ˆæ¯æ˜¾ç¤º -->
        <div class="section">
            <h2>ğŸ“¨ å®æ—¶æ¶ˆæ¯ (åç«¯æ—¥å¿—åŒæ­¥æ˜¾ç¤º)</h2>
            <div id="messages" class="messages">
                <div class="message">ç­‰å¾…è¿æ¥...</div>
            </div>
        </div>

        <!-- èŠå¤©å†å²æ˜¾ç¤º -->
        <div class="section" id="chatHistorySection" style="display:none;">
            <h2>ğŸ’­ èŠå¤©å†å²è®°å½•</h2>
            <div id="chatHistory" class="chat-history">
                <!-- èŠå¤©è®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div class="section">
            <h2>âœ… æµ‹è¯•ç»“æœæ±‡æ€»</h2>
            <div id="testResults">
                <div class="status info">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
            </div>
        </div>

        <!-- å®æ—¶èŠå¤©çª—å£ -->
        <div class="section">
            <h2>ğŸ’¬ å®æ—¶èŠå¤©çª—å£</h2>
            <div id="chatWindow" class="chat-window disabled">
                <div class="chat-header">
                    <div>
                        <span id="chatTitle">è¯·é€‰æ‹©åŒ¹é…å¹¶å¯åŠ¨ç§ä¿¡æµç¨‹</span>
                    </div>
                    <div class="chat-status" id="chatStatus">æœªè¿æ¥</div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-chat">ğŸ’¬ å¼€å§‹ä½ ä»¬çš„å¯¹è¯å§...</div>
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-group">
                        <textarea id="messageInput" class="chat-input" 
                                placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" 
                                disabled></textarea>
                        <button id="sendBtn" class="send-btn" onclick="sendMessage()" disabled>
                            å‘é€ ğŸ“¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let websocket = null;
        let userId = null;
        let currentStep = 0;
        let testResults = [];
        let currentChatroom = null;
        let targetUserId = null;

        function connect() {
            userId = parseInt(document.getElementById('userIdInput').value);
            if (!userId) {
                alert('è¯·è¾“å…¥ç”¨æˆ·ID');
                return;
            }

            const wsUrl = `ws://localhost:8000/ws/message?user_id=${userId}`;
            websocket = new WebSocket(wsUrl);

            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectionStatus').style.display = 'block';
            document.getElementById('connectionStatus').textContent = 'æ­£åœ¨è¿æ¥...';
            document.getElementById('connectionStatus').className = 'status info';

            websocket.onopen = function(event) {
                console.log('WebSocketè¿æ¥å·²å»ºç«‹ï¼Œå‘é€è®¤è¯æ¶ˆæ¯...');
                document.getElementById('connectionStatus').textContent = 'ğŸ” æ­£åœ¨è®¤è¯...';
                document.getElementById('connectionStatus').className = 'status info';
                
                // å‘é€è®¤è¯æ¶ˆæ¯
                const authMessage = {
                    user_id: userId
                };
                websocket.send(JSON.stringify(authMessage));
                addMessage('ç³»ç»Ÿ', `ğŸ” å‘é€è®¤è¯æ¶ˆæ¯: ç”¨æˆ·ID ${userId}`, 'info');
            };

            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
                handleMessage(data);
            };

            websocket.onclose = function(event) {
                console.log('WebSocketè¿æ¥å·²å…³é—­');
                document.getElementById('connectionStatus').textContent = 'âŒ è¿æ¥å·²æ–­å¼€';
                document.getElementById('connectionStatus').className = 'status error';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('startPrivateChatBtn').disabled = true;
                
                addMessage('ç³»ç»Ÿ', 'âŒ WebSocketè¿æ¥å·²æ–­å¼€', 'error');
                resetSteps();
            };

            websocket.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                document.getElementById('connectionStatus').textContent = 'âŒ è¿æ¥é”™è¯¯';
                document.getElementById('connectionStatus').className = 'status error';
                document.getElementById('connectBtn').disabled = false;
                
                addMessage('ç³»ç»Ÿ', 'âŒ WebSocketè¿æ¥å‡ºé”™', 'error');
            };
        }

        function startPrivateChat() {
            const targetUserId = parseInt(document.getElementById('targetUserIdInput').value);
            const matchId = parseInt(document.getElementById('matchIdInput').value);

            if (!targetUserId || !matchId) {
                alert('è¯·è¾“å…¥ç›®æ ‡ç”¨æˆ·IDå’ŒåŒ¹é…ID');
                return;
            }

            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                alert('WebSocketæœªè¿æ¥');
                return;
            }

            // é‡ç½®çŠ¶æ€
            resetSteps();
            testResults = [];
            document.getElementById('chatHistorySection').style.display = 'none';
            document.getElementById('startPrivateChatBtn').disabled = true;

            // å‘é€ç§ä¿¡æµç¨‹åˆå§‹åŒ–æ¶ˆæ¯
            const message = {
                type: 'private_chat_init',
                target_user_id: targetUserId,
                match_id: matchId
            };

            websocket.send(JSON.stringify(message));
            addMessage('å‘é€', `ğŸš€ å¯åŠ¨ç§ä¿¡æµç¨‹: ç”¨æˆ·${targetUserId}, åŒ¹é…${matchId}`, 'info');
        }

        function handleMessage(data) {
            const type = data.type;
            const timestamp = new Date().toLocaleTimeString();

            switch(type) {
                case 'authenticated':
                    // è®¤è¯æˆåŠŸ
                    document.getElementById('connectionStatus').textContent = `âœ… è®¤è¯æˆåŠŸ (ç”¨æˆ·ID: ${data.user_id})`;
                    document.getElementById('connectionStatus').className = 'status success';
                    document.getElementById('startPrivateChatBtn').disabled = false;
                    addMessage('ç³»ç»Ÿ', `âœ… è®¤è¯æˆåŠŸï¼ç”¨æˆ·ID: ${data.user_id}ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ç§ä¿¡æµç¨‹ã€‚`, 'success');
                    break;

                case undefined:
                    // å¤„ç†æ²¡æœ‰typeå­—æ®µçš„æ¶ˆæ¯ï¼ˆå¦‚è®¤è¯å“åº”ï¼‰
                    if (data.status === 'authenticated') {
                        document.getElementById('connectionStatus').textContent = `âœ… è®¤è¯æˆåŠŸ (ç”¨æˆ·ID: ${data.user_id})`;
                        document.getElementById('connectionStatus').className = 'status success';
                        document.getElementById('startPrivateChatBtn').disabled = false;
                        addMessage('ç³»ç»Ÿ', `âœ… è®¤è¯æˆåŠŸï¼ç”¨æˆ·ID: ${data.user_id}ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ç§ä¿¡æµç¨‹ã€‚`, 'success');
                        // åŠ è½½åŒ¹é…åˆ—è¡¨
                        loadMatchList(data.user_id);
                    }
                    break;

                case 'private_chat_progress':
                    handleProgress(data);
                    break;
                
                case 'private_chat_init_complete':
                    handleComplete(data);
                    break;
                
                case 'private_chat_error':
                    handleError(data);
                    break;

                case 'error':
                    addMessage('é”™è¯¯', `âŒ ${data.error}`, 'error');
                    break;
                
                case 'message_received':
                case 'new_message':
                case 'private_message':
                    // å¤„ç†æ¥æ”¶åˆ°çš„æ–°æ¶ˆæ¯
                    handleIncomingMessage(data);
                    break;
                
                case 'message_status':
                    // å¤„ç†æ¶ˆæ¯å‘é€çŠ¶æ€
                    handleMessageStatus(data);
                    break;
                
                default:
                    addMessage('å…¶ä»–', `ğŸ“© ${type}: ${JSON.stringify(data)}`, 'info');
                    break;
            }
        }

        function handleProgress(data) {
            const step = data.step;
            const message = data.message;
            const status = data.status;

            if (status === 'completed') {
                // æ ‡è®°æ­¥éª¤å®Œæˆ
                document.getElementById(`step${step}`).className = 'step completed';
                addMessage(`æ­¥éª¤${step}`, `âœ… ${message}`, 'success');
                
                // è®°å½•æµ‹è¯•ç»“æœ
                testResults.push({
                    step: step,
                    status: 'æˆåŠŸ',
                    message: message,
                    data: data
                });

                if (step === 1) {
                    addMessage('è¯¦æƒ…', `ğŸ  èŠå¤©å®¤ID: ${data.chatroom_id}`, 'info');
                } else if (step === 2) {
                    addMessage('è¯¦æƒ…', `ğŸ’¬ èŠå¤©è®°å½•: ${data.chat_history ? data.chat_history.length : 0} æ¡`, 'info');
                }
            } else {
                // æ ‡è®°æ­¥éª¤è¿›è¡Œä¸­
                document.getElementById(`step${step}`).className = 'step active';
                addMessage(`æ­¥éª¤${step}`, `â³ ${message}`, 'info');
            }
        }

        function handleComplete(data) {
            // æ ‡è®°ç¬¬3æ­¥å®Œæˆ
            document.getElementById('step3').className = 'step completed';
            addMessage('å®Œæˆ', `ğŸ‰ ${data.message}`, 'success');
            
            // ä¿å­˜å½“å‰èŠå¤©å®¤ä¿¡æ¯
            currentChatroom = data.chatroom_id;
            targetUserId = parseInt(document.getElementById('targetUserIdInput').value);
            
            // å¯ç”¨èŠå¤©çª—å£
            enableChatWindow(data);
            
            // æ˜¾ç¤ºèŠå¤©å†å²
            if (data.chat_history && data.chat_history.length > 0) {
                displayChatHistory(data.chat_history);
                displayChatInWindow(data.chat_history);
            }

            // æ˜¾ç¤ºæµ‹è¯•ç»“æœæ±‡æ€»
            displayTestResults();

            // é‡æ–°å¯ç”¨æŒ‰é’®
            document.getElementById('startPrivateChatBtn').disabled = false;
        }

        function handleError(data) {
            const step = data.step || 'æœªçŸ¥';
            const error = data.error;
            
            addMessage('é”™è¯¯', `âŒ æ­¥éª¤${step}: ${error}`, 'error');
            
            // è®°å½•é”™è¯¯
            testResults.push({
                step: step,
                status: 'å¤±è´¥',
                message: error,
                data: data
            });

            // é‡æ–°å¯ç”¨æŒ‰é’®
            document.getElementById('startPrivateChatBtn').disabled = false;
            
            // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
            displayTestResults();
        }

        function displayChatHistory(chatHistory) {
            const chatHistoryDiv = document.getElementById('chatHistory');
            chatHistoryDiv.innerHTML = '';
            
            if (chatHistory.length === 0) {
                chatHistoryDiv.innerHTML = '<div class="status info">æš‚æ— èŠå¤©è®°å½•</div>';
            } else {
                chatHistory.forEach(msg => {
                    const [message, datetime, senderId, senderName] = msg;
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-message ${senderName === 'I' ? 'self' : 'other'}`;
                    
                    messageDiv.innerHTML = `
                        <div class="sender">${senderName} (ID: ${senderId})</div>
                        <div>${message}</div>
                        <div class="time">${datetime}</div>
                    `;
                    
                    chatHistoryDiv.appendChild(messageDiv);
                });
            }
            
            document.getElementById('chatHistorySection').style.display = 'block';
        }

        function displayTestResults() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';

            if (testResults.length === 0) {
                resultsDiv.innerHTML = '<div class="status info">æš‚æ— æµ‹è¯•ç»“æœ</div>';
                return;
            }

            testResults.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = `status ${result.status === 'æˆåŠŸ' ? 'success' : 'error'}`;
                resultDiv.innerHTML = `
                    <strong>æ­¥éª¤${result.step}:</strong> ${result.status} - ${result.message}
                `;
                resultsDiv.appendChild(resultDiv);
            });

            // æ·»åŠ æ€»ç»“
            const successCount = testResults.filter(r => r.status === 'æˆåŠŸ').length;
            const totalCount = testResults.length;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = `status ${successCount === totalCount ? 'success' : 'error'}`;
            summaryDiv.innerHTML = `
                <strong>æµ‹è¯•æ€»ç»“:</strong> ${successCount}/${totalCount} ä¸ªæ­¥éª¤æˆåŠŸå®Œæˆ
            `;
            resultsDiv.appendChild(summaryDiv);
        }

        async function loadMatchList(userId) {
            try {
                addMessage('ç³»ç»Ÿ', 'ğŸ”„ æ­£åœ¨ä»æ•°æ®åº“åŠ è½½çœŸå®åŒ¹é…åˆ—è¡¨...', 'info');
                
                // é¦–å…ˆéœ€è¦è·å–ç”¨æˆ·çš„match_idsï¼Œç„¶åé€ä¸€è·å–åŒ¹é…ä¿¡æ¯
                // ç”±äºæ²¡æœ‰ç›´æ¥çš„è·å–ç”¨æˆ·åŒ¹é…åˆ—è¡¨çš„APIï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ç”¨æˆ·ä¿¡æ¯è·å–match_ids
                const userInfoResponse = await fetch('http://localhost:8000/api/v1/UserManagement/get_user_info_with_user_id', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId
                    })
                });
                
                if (!userInfoResponse.ok) {
                    throw new Error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }
                
                const userInfo = await userInfoResponse.json();
                addMessage('ç³»ç»Ÿ', `ğŸ“‹ ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸï¼Œmatch_ids: ${JSON.stringify(userInfo.match_ids)}`, 'info');
                
                const matchIds = userInfo.match_ids || [];
                if (matchIds.length === 0) {
                    displayMatchList([]);
                    addMessage('ç³»ç»Ÿ', 'âš ï¸ è¯¥ç”¨æˆ·æš‚æ— åŒ¹é…è®°å½•', 'info');
                    return;
                }
                
                // é€ä¸€è·å–æ¯ä¸ªåŒ¹é…çš„è¯¦ç»†ä¿¡æ¯
                const matches = [];
                for (const matchId of matchIds) {
                    try {
                        const matchInfoResponse = await fetch('http://localhost:8000/api/v1/MatchManager/get_match_info', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                user_id: userId,
                                match_id: matchId
                            })
                        });
                        
                        if (matchInfoResponse.ok) {
                            const matchInfo = await matchInfoResponse.json();
                            
                            // è·å–ç›®æ ‡ç”¨æˆ·çš„åç§°
                            const targetUserResponse = await fetch('http://localhost:8000/api/v1/UserManagement/get_user_info_with_user_id', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    user_id: matchInfo.target_user_id
                                })
                            });
                            
                            let targetUserName = `ç”¨æˆ·${matchInfo.target_user_id}`;
                            if (targetUserResponse.ok) {
                                const targetUserInfo = await targetUserResponse.json();
                                targetUserName = targetUserInfo.telegram_user_name || targetUserName;
                            }
                            
                            matches.push({
                                match_id: matchId,
                                target_user_id: matchInfo.target_user_id,
                                target_user_name: targetUserName,
                                description_for_target: matchInfo.description_for_target,
                                is_liked: matchInfo.is_liked,
                                match_score: matchInfo.match_score,
                                chatroom_id: matchInfo.chatroom_id
                            });
                            
                            addMessage('ç³»ç»Ÿ', `âœ… åŒ¹é… ${matchId} ä¿¡æ¯åŠ è½½æˆåŠŸ`, 'info');
                        } else {
                            addMessage('ç³»ç»Ÿ', `âš ï¸ åŒ¹é… ${matchId} ä¿¡æ¯åŠ è½½å¤±è´¥`, 'error');
                        }
                    } catch (error) {
                        addMessage('ç³»ç»Ÿ', `âŒ åŒ¹é… ${matchId} åŠ è½½å‡ºé”™: ${error.message}`, 'error');
                    }
                }
                
                displayMatchList(matches);
                addMessage('ç³»ç»Ÿ', `âœ… å·²ä»æ•°æ®åº“åŠ è½½ ${matches.length} ä¸ªçœŸå®åŒ¹é…`, 'success');
                
            } catch (error) {
                console.error('åŠ è½½åŒ¹é…åˆ—è¡¨å¤±è´¥:', error);
                addMessage('ç³»ç»Ÿ', `âŒ åŠ è½½åŒ¹é…åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ä½†ä¸é˜»å¡æµ‹è¯•
                document.getElementById('matchListSection').style.display = 'block';
                document.getElementById('matchList').innerHTML = `
                    <div class="status error">
                        åŠ è½½å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥åŒ¹é…ä¿¡æ¯è¿›è¡Œæµ‹è¯•<br>
                        é”™è¯¯ä¿¡æ¯: ${error.message}
                    </div>
                `;
            }
        }
        
        function displayMatchList(matches) {
            const matchListDiv = document.getElementById('matchList');
            const matchListSection = document.getElementById('matchListSection');
            
            matchListDiv.innerHTML = '';
            
            if (matches.length === 0) {
                matchListDiv.innerHTML = '<div class="status info">æš‚æ— å¯ç”¨åŒ¹é…</div>';
            } else {
                matches.forEach(match => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match-item';
                    matchDiv.dataset.matchId = match.match_id;
                    matchDiv.dataset.targetUserId = match.target_user_id;
                    
                    matchDiv.innerHTML = `
                        <div class="match-header">
                            <div class="match-title">${match.target_user_name}</div>
                            <div class="match-score">åŒ¹é…åº¦: ${match.match_score}%</div>
                        </div>
                        <div class="match-description">${match.description_for_target}</div>
                        <div class="match-info">
                            <div>åŒ¹é…ID: ${match.match_id}</div>
                            <div class="match-status">
                                ${match.is_liked ? '<span class="status-badge liked">å·²ç‚¹èµ</span>' : ''}
                                ${match.chatroom_id ? '<span class="status-badge chatroom">æœ‰èŠå¤©å®¤</span>' : ''}
                            </div>
                        </div>
                    `;
                    
                    matchDiv.onclick = function() {
                        selectMatch(match);
                    };
                    
                    matchListDiv.appendChild(matchDiv);
                });
            }
            
            matchListSection.style.display = 'block';
        }
        
        function selectMatch(match) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰æ‹©
            document.querySelectorAll('.match-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // é€‰æ‹©å½“å‰åŒ¹é…
            const matchElement = document.querySelector(`[data-match-id="${match.match_id}"]`);
            if (matchElement) {
                matchElement.classList.add('selected');
            }
            
            // è‡ªåŠ¨å¡«å……è¡¨å•
            document.getElementById('targetUserIdInput').value = match.target_user_id;
            document.getElementById('matchIdInput').value = match.match_id;
            
            addMessage('é€‰æ‹©', `âœ… å·²é€‰æ‹©åŒ¹é…: ${match.target_user_name} (åŒ¹é…ID: ${match.match_id})`, 'success');
        }

        function addMessage(sender, content, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <span class="timestamp">${timestamp}</span>
                <strong>[${sender}]</strong> ${content}
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function resetSteps() {
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`step${i}`).className = 'step';
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        window.onload = function() {
            addMessage('ç³»ç»Ÿ', 'ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ç§ä¿¡æµç¨‹æµ‹è¯•é¡µé¢ï¼è¯·å…ˆè¿æ¥WebSocketã€‚', 'info');
        };

        // å¯ç”¨èŠå¤©çª—å£
        function enableChatWindow(data) {
            const chatWindow = document.getElementById('chatWindow');
            const chatTitle = document.getElementById('chatTitle');
            const chatStatus = document.getElementById('chatStatus');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            // å¯ç”¨èŠå¤©çª—å£
            chatWindow.classList.remove('disabled');
            
            // è®¾ç½®èŠå¤©æ ‡é¢˜
            const targetUserName = document.querySelector('.match-item.selected .match-title')?.textContent || `ç”¨æˆ·${targetUserId}`;
            chatTitle.textContent = `ä¸ ${targetUserName} çš„ç§ä¿¡ (èŠå¤©å®¤: ${currentChatroom})`;
            
            // è®¾ç½®çŠ¶æ€
            chatStatus.textContent = 'å·²è¿æ¥';
            
            // å¯ç”¨è¾“å…¥æ§ä»¶
            messageInput.disabled = false;
            sendBtn.disabled = false;
            
            addMessage('èŠå¤©', 'ğŸ’¬ èŠå¤©çª—å£å·²å¯ç”¨ï¼Œå¯ä»¥å¼€å§‹å‘é€æ¶ˆæ¯ï¼', 'success');
        }

        // åœ¨èŠå¤©çª—å£ä¸­æ˜¾ç¤ºèŠå¤©å†å²
        function displayChatInWindow(chatHistory) {
            const chatMessages = document.getElementById('chatMessages');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            chatMessages.innerHTML = '';
            
            if (chatHistory.length === 0) {
                chatMessages.innerHTML = '<div class="empty-chat">ğŸ’¬ å¼€å§‹ä½ ä»¬çš„å¯¹è¯å§...</div>';
            } else {
                chatHistory.forEach(msg => {
                    const [message, datetime, senderId, senderName] = msg;
                    addChatMessage(message, senderId === userId, senderName, datetime);
                });
            }
        }

        // æ·»åŠ èŠå¤©æ¶ˆæ¯åˆ°çª—å£
        function addChatMessage(message, isSent, senderName, timestamp) {
            const chatMessages = document.getElementById('chatMessages');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œæ¸…é™¤ç©ºç™½æç¤º
            const emptyChat = chatMessages.querySelector('.empty-chat');
            if (emptyChat) {
                emptyChat.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `real-chat-message ${isSent ? 'sent' : 'received'}`;
            
            const displayTime = timestamp || new Date().toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div>${message}</div>
                <div class="message-info">${displayTime} ${isSent ? '' : 'â€¢ ' + senderName}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                return;
            }
            
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                alert('WebSocketæœªè¿æ¥');
                return;
            }
            
            if (!currentChatroom) {
                alert('è¯·å…ˆå¯åŠ¨ç§ä¿¡æµç¨‹å¹¶è·å–èŠå¤©å®¤ID');
                return;
            }
            
            // ä½¿ç”¨åç«¯æ”¯æŒçš„privateæ¶ˆæ¯æ ¼å¼
            const messageData = {
                type: 'private',
                target_user_id: targetUserId.toString(),
                chatroom_id: currentChatroom,  // æ·»åŠ å¿…éœ€çš„chatroom_idå‚æ•°
                content: message,
                timestamp: new Date().toISOString()
            };
            
            websocket.send(JSON.stringify(messageData));
            
            // ç«‹å³åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºå‘é€çš„æ¶ˆæ¯ï¼ˆä¹è§‚æ›´æ–°ï¼‰
            addChatMessage(message, true, 'æˆ‘', null);
            addMessage('å‘é€', `ğŸ“¤ å‘é€ç§èŠæ¶ˆæ¯: ${message}`, 'info');
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            messageInput.value = '';
        }

        // å¤„ç†WebSocketæ”¶åˆ°çš„æ–°æ¶ˆæ¯
        async function handleIncomingMessage(data) {
            // å¤„ç†private_messageæ ¼å¼çš„æ¶ˆæ¯
            if (data.type === 'private_message') {
                let senderName = `ç”¨æˆ·${data.from}`;
                
                // å°è¯•è·å–å‘é€è€…çš„çœŸå®å§“å
                try {
                    const userResponse = await fetch('http://localhost:8000/api/v1/UserManagement/get_user_info_with_user_id', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: parseInt(data.from)
                        })
                    });
                    
                    if (userResponse.ok) {
                        const userInfo = await userResponse.json();
                        senderName = userInfo.telegram_user_name || senderName;
                    }
                } catch (error) {
                    console.log('è·å–ç”¨æˆ·åå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åç§°:', error);
                }
                
                const message = data.content;
                const timestamp = data.timestamp;
                
                // æ˜¾ç¤ºåœ¨èŠå¤©çª—å£ä¸­
                addChatMessage(message, false, senderName, timestamp);
                addMessage('æ¥æ”¶', `ğŸ“¨ æ”¶åˆ°ç§èŠæ¶ˆæ¯: ${message} (æ¥è‡ª: ${senderName})`, 'success');
            } else {
                // å¤„ç†å…¶ä»–æ ¼å¼çš„æ¶ˆæ¯ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
                if (data.chatroom_id === currentChatroom || !data.chatroom_id) {
                    const senderName = data.sender_name || `ç”¨æˆ·${data.sender_id}`;
                    const message = data.message || data.content;
                    const isFromSelf = data.sender_id === userId || data.from === userId;
                    
                    addChatMessage(message, isFromSelf, senderName, data.timestamp);
                    addMessage('æ¥æ”¶', `ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${message}`, 'success');
                }
            }
        }

        // å¤„ç†æ¶ˆæ¯å‘é€çŠ¶æ€
        function handleMessageStatus(data) {
            const delivered = data.delivered;
            const content = data.content;
            const targetUserId = data.target_user_id;
            
            if (delivered) {
                addMessage('çŠ¶æ€', `âœ… æ¶ˆæ¯å·²å‘é€ç»™ç”¨æˆ·${targetUserId}: "${content}"`, 'success');
            } else {
                addMessage('çŠ¶æ€', `âŒ æ¶ˆæ¯å‘é€å¤±è´¥ç»™ç”¨æˆ·${targetUserId}: "${content}"`, 'error');
            }
        }

        // ç›‘å¬Enteré”®å‘é€æ¶ˆæ¯
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        });
    </script>
</body>
</html>