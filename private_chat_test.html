<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁßÅ‰ø°ÊµÅÁ®ãÊµãËØïÈ°µÈù¢</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        .section h2 {
            color: #007bff;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0,123,255,0.3);
        }
        button {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .messages {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
        }
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }
        .message .timestamp {
            font-size: 12px;
            color: #666;
            float: right;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            margin: 0 5px;
            border-radius: 8px;
            background: #e9ecef;
            color: #6c757d;
            font-weight: bold;
        }
        .step.active {
            background: #007bff;
            color: white;
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .chat-history {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .chat-message {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 15px;
            max-width: 70%;
        }
        .chat-message.self {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .chat-message.other {
            background: #e9ecef;
            color: #333;
        }
        .chat-message .sender {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 3px;
        }
        .chat-message .time {
            font-size: 11px;
            opacity: 0.7;
        }
        .match-list {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .match-item {
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }
        .match-item:hover {
            background: #e3f2fd;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.2);
        }
        .match-item.selected {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .match-title {
            font-weight: bold;
            font-size: 16px;
        }
        .match-score {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
        }
        .match-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .match-item.selected .match-description {
            color: #e9ecef;
        }
        .match-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }
        .match-status {
            display: flex;
            gap: 10px;
        }
        .status-badge {
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
        }
        .status-badge.liked {
            background: #dc3545;
            color: white;
        }
        .status-badge.chatroom {
            background: #17a2b8;
            color: white;
        }
        
        /* ÂÆûÊó∂ËÅäÂ§©Á™óÂè£Ê†∑Âºè */
        .chat-window {
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 0;
            max-height: 500px;
            display: flex;
            flex-direction: column;
        }
        .chat-window.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        .chat-header {
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 6px 6px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-status {
            font-size: 12px;
            opacity: 0.9;
        }
        .chat-messages {
            flex: 1;
            max-height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }
        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #dee2e6;
            border-radius: 0 0 6px 6px;
        }
        .chat-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .chat-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 20px;
            resize: none;
            min-height: 40px;
            max-height: 100px;
        }
        .chat-input:focus {
            outline: none;
            border-color: #007bff;
        }
        .send-btn {
            width: auto;
            padding: 10px 20px;
            border-radius: 20px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            margin: 0;
        }
        .send-btn:hover {
            background: #0056b3;
        }
        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .real-chat-message {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .real-chat-message.sent {
            background: #007bff;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .real-chat-message.received {
            background: #e9ecef;
            color: #333;
            margin-right: auto;
        }
        .real-chat-message .message-info {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }
        .real-chat-message.sent .message-info {
            text-align: right;
        }
        .empty-chat {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîí ÁßÅ‰ø°ÊµÅÁ®ãÊµãËØïÈ°µÈù¢</h1>
        
        <!-- ËøûÊé•Áä∂ÊÄÅ -->
        <div class="section">
            <h2>üì° WebSocket ËøûÊé•</h2>
            <div class="form-group">
                <label>Áî®Êà∑ID:</label>
                <input type="number" id="userIdInput" placeholder="ËæìÂÖ•‰Ω†ÁöÑÁî®Êà∑ID" value="1">
            </div>
            <button id="connectBtn" onclick="connect()">ËøûÊé• WebSocket</button>
            <div id="connectionStatus" class="status info" style="display:none;">ÂáÜÂ§áËøûÊé•...</div>
        </div>

        <!-- Ê≠•È™§ÊåáÁ§∫Âô® -->
        <div class="section">
            <h2>üìã ÁßÅ‰ø°ÊµÅÁ®ãÊ≠•È™§</h2>
            <div class="step-indicator">
                <div class="step" id="step1">Ê≠•È™§1: Ëé∑Âèñ/ÂàõÂª∫ËÅäÂ§©ÂÆ§</div>
                <div class="step" id="step2">Ê≠•È™§2: Ëé∑ÂèñËÅäÂ§©ÂéÜÂè≤</div>
                <div class="step" id="step3">Ê≠•È™§3: ÂÆåÊàêÂàùÂßãÂåñ</div>
            </div>
        </div>

        <!-- ÂåπÈÖçÂàóË°®ÊòæÁ§∫ -->
        <div class="section" id="matchListSection" style="display:none;">
            <h2>üíï ÂèØÁî®ÁöÑÂåπÈÖçÂàóË°®</h2>
            <div id="matchList" class="match-list">
                <!-- ÂåπÈÖçÂàóË°®Â∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
        </div>
            <div class="form-group">
                <label>ÁõÆÊ†áÁî®Êà∑ID:</label>
                <input type="number" id="targetUserIdInput" placeholder="ËæìÂÖ•ÁõÆÊ†áÁî®Êà∑ID" value="2">
            </div>
            <div class="form-group">
                <label>ÂåπÈÖçID:</label>
                <input type="number" id="matchIdInput" placeholder="ËæìÂÖ•ÂåπÈÖçID" value="1">
            </div>
            <button id="startPrivateChatBtn" onclick="startPrivateChat()" disabled>ÂêØÂä®ÁßÅ‰ø°ÊµÅÁ®ã</button>
        </div>

        <!-- ÂÆûÊó∂Ê∂àÊÅØÊòæÁ§∫ -->
        <div class="section">
            <h2>üì® ÂÆûÊó∂Ê∂àÊÅØ (ÂêéÁ´ØÊó•ÂøóÂêåÊ≠•ÊòæÁ§∫)</h2>
            <div id="messages" class="messages">
                <div class="message">Á≠âÂæÖËøûÊé•...</div>
            </div>
        </div>

        <!-- ËÅäÂ§©ÂéÜÂè≤ÊòæÁ§∫ -->
        <div class="section" id="chatHistorySection" style="display:none;">
            <h2>üí≠ ËÅäÂ§©ÂéÜÂè≤ËÆ∞ÂΩï</h2>
            <div id="chatHistory" class="chat-history">
                <!-- ËÅäÂ§©ËÆ∞ÂΩïÂ∞ÜÂú®ËøôÈáåÊòæÁ§∫ -->
            </div>
        </div>

        <!-- ÊµãËØïÁªìÊûú -->
        <div class="section">
            <h2>‚úÖ ÊµãËØïÁªìÊûúÊ±áÊÄª</h2>
            <div id="testResults">
                <div class="status info">Á≠âÂæÖÊµãËØïÂºÄÂßã...</div>
            </div>
        </div>

        <!-- ÂÆûÊó∂ËÅäÂ§©Á™óÂè£ -->
        <div class="section">
            <h2>üí¨ ÂÆûÊó∂ËÅäÂ§©Á™óÂè£</h2>
            <div id="chatWindow" class="chat-window disabled">
                <div class="chat-header">
                    <div>
                        <span id="chatTitle">ËØ∑ÈÄâÊã©ÂåπÈÖçÂπ∂ÂêØÂä®ÁßÅ‰ø°ÊµÅÁ®ã</span>
                    </div>
                    <div class="chat-status" id="chatStatus">Êú™ËøûÊé•</div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-chat">üí¨ ÂºÄÂßã‰Ω†‰ª¨ÁöÑÂØπËØùÂêß...</div>
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-group">
                        <textarea id="messageInput" class="chat-input" 
                                placeholder="ËæìÂÖ•Ê∂àÊÅØ..." rows="1" 
                                disabled></textarea>
                        <button id="sendBtn" class="send-btn" onclick="sendMessage()" disabled>
                            ÂèëÈÄÅ üì§
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let websocket = null;
        let userId = null;
        let currentStep = 0;
        let testResults = [];
        let currentChatroom = null;
        let targetUserId = null;

        function connect() {
            userId = parseInt(document.getElementById('userIdInput').value);
            if (!userId) {
                alert('ËØ∑ËæìÂÖ•Áî®Êà∑ID');
                return;
            }

            const wsUrl = `ws://localhost:8000/ws/message?user_id=${userId}`;
            websocket = new WebSocket(wsUrl);

            document.getElementById('connectBtn').disabled = true;
            document.getElementById('connectionStatus').style.display = 'block';
            document.getElementById('connectionStatus').textContent = 'Ê≠£Âú®ËøûÊé•...';
            document.getElementById('connectionStatus').className = 'status info';

            websocket.onopen = function(event) {
                console.log('WebSocketËøûÊé•Â∑≤Âª∫Á´ãÔºåÂèëÈÄÅËÆ§ËØÅÊ∂àÊÅØ...');
                document.getElementById('connectionStatus').textContent = 'üîê Ê≠£Âú®ËÆ§ËØÅ...';
                document.getElementById('connectionStatus').className = 'status info';
                
                // ÂèëÈÄÅËÆ§ËØÅÊ∂àÊÅØ
                const authMessage = {
                    user_id: userId
                };
                websocket.send(JSON.stringify(authMessage));
                addMessage('Á≥ªÁªü', `üîê ÂèëÈÄÅËÆ§ËØÅÊ∂àÊÅØ: Áî®Êà∑ID ${userId}`, 'info');
            };

            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Êî∂Âà∞Ê∂àÊÅØ:', data);
                handleMessage(data);
            };

            websocket.onclose = function(event) {
                console.log('WebSocketËøûÊé•Â∑≤ÂÖ≥Èó≠');
                document.getElementById('connectionStatus').textContent = '‚ùå ËøûÊé•Â∑≤Êñ≠ÂºÄ';
                document.getElementById('connectionStatus').className = 'status error';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('startPrivateChatBtn').disabled = true;
                
                addMessage('Á≥ªÁªü', '‚ùå WebSocketËøûÊé•Â∑≤Êñ≠ÂºÄ', 'error');
                resetSteps();
            };

            websocket.onerror = function(error) {
                console.error('WebSocketÈîôËØØ:', error);
                document.getElementById('connectionStatus').textContent = '‚ùå ËøûÊé•ÈîôËØØ';
                document.getElementById('connectionStatus').className = 'status error';
                document.getElementById('connectBtn').disabled = false;
                
                addMessage('Á≥ªÁªü', '‚ùå WebSocketËøûÊé•Âá∫Èîô', 'error');
            };
        }

        function startPrivateChat() {
            const targetUserId = parseInt(document.getElementById('targetUserIdInput').value);
            const matchId = parseInt(document.getElementById('matchIdInput').value);

            if (!targetUserId || !matchId) {
                alert('ËØ∑ËæìÂÖ•ÁõÆÊ†áÁî®Êà∑IDÂíåÂåπÈÖçID');
                return;
            }

            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                alert('WebSocketÊú™ËøûÊé•');
                return;
            }

            // ÈáçÁΩÆÁä∂ÊÄÅ
            resetSteps();
            testResults = [];
            document.getElementById('chatHistorySection').style.display = 'none';
            document.getElementById('startPrivateChatBtn').disabled = true;

            // ÂèëÈÄÅÁßÅ‰ø°ÊµÅÁ®ãÂàùÂßãÂåñÊ∂àÊÅØ
            const message = {
                type: 'private_chat_init',
                target_user_id: targetUserId,
                match_id: matchId
            };

            websocket.send(JSON.stringify(message));
            addMessage('ÂèëÈÄÅ', `üöÄ ÂêØÂä®ÁßÅ‰ø°ÊµÅÁ®ã: Áî®Êà∑${targetUserId}, ÂåπÈÖç${matchId}`, 'info');
        }

        function handleMessage(data) {
            const type = data.type;
            const timestamp = new Date().toLocaleTimeString();

            switch(type) {
                case 'authenticated':
                    // ËÆ§ËØÅÊàêÂäü
                    document.getElementById('connectionStatus').textContent = `‚úÖ ËÆ§ËØÅÊàêÂäü (Áî®Êà∑ID: ${data.user_id})`;
                    document.getElementById('connectionStatus').className = 'status success';
                    document.getElementById('startPrivateChatBtn').disabled = false;
                    addMessage('Á≥ªÁªü', `‚úÖ ËÆ§ËØÅÊàêÂäüÔºÅÁî®Êà∑ID: ${data.user_id}ÔºåÂèØ‰ª•ÂºÄÂßãÊµãËØïÁßÅ‰ø°ÊµÅÁ®ã„ÄÇ`, 'success');
                    break;

                case undefined:
                    // Â§ÑÁêÜÊ≤°ÊúâtypeÂ≠óÊÆµÁöÑÊ∂àÊÅØÔºàÂ¶ÇËÆ§ËØÅÂìçÂ∫îÔºâ
                    if (data.status === 'authenticated') {
                        document.getElementById('connectionStatus').textContent = `‚úÖ ËÆ§ËØÅÊàêÂäü (Áî®Êà∑ID: ${data.user_id})`;
                        document.getElementById('connectionStatus').className = 'status success';
                        document.getElementById('startPrivateChatBtn').disabled = false;
                        addMessage('Á≥ªÁªü', `‚úÖ ËÆ§ËØÅÊàêÂäüÔºÅÁî®Êà∑ID: ${data.user_id}ÔºåÂèØ‰ª•ÂºÄÂßãÊµãËØïÁßÅ‰ø°ÊµÅÁ®ã„ÄÇ`, 'success');
                        // Âä†ËΩΩÂåπÈÖçÂàóË°®
                        loadMatchList(data.user_id);
                    }
                    break;

                case 'private_chat_progress':
                    handleProgress(data);
                    break;
                
                case 'private_chat_init_complete':
                    handleComplete(data);
                    break;
                
                case 'private_chat_error':
                    handleError(data);
                    break;

                case 'error':
                    addMessage('ÈîôËØØ', `‚ùå ${data.error}`, 'error');
                    break;
                
                case 'message_received':
                case 'new_message':
                case 'private_message':
                    // Â§ÑÁêÜÊé•Êî∂Âà∞ÁöÑÊñ∞Ê∂àÊÅØ
                    handleIncomingMessage(data);
                    break;
                
                case 'message_status':
                    // Â§ÑÁêÜÊ∂àÊÅØÂèëÈÄÅÁä∂ÊÄÅ
                    handleMessageStatus(data);
                    break;
                
                default:
                    addMessage('ÂÖ∂‰ªñ', `üì© ${type}: ${JSON.stringify(data)}`, 'info');
                    break;
            }
        }

        function handleProgress(data) {
            const step = data.step;
            const message = data.message;
            const status = data.status;

            if (status === 'completed') {
                // Ê†áËÆ∞Ê≠•È™§ÂÆåÊàê
                document.getElementById(`step${step}`).className = 'step completed';
                addMessage(`Ê≠•È™§${step}`, `‚úÖ ${message}`, 'success');
                
                // ËÆ∞ÂΩïÊµãËØïÁªìÊûú
                testResults.push({
                    step: step,
                    status: 'ÊàêÂäü',
                    message: message,
                    data: data
                });

                if (step === 1) {
                    addMessage('ËØ¶ÊÉÖ', `üè† ËÅäÂ§©ÂÆ§ID: ${data.chatroom_id}`, 'info');
                } else if (step === 2) {
                    addMessage('ËØ¶ÊÉÖ', `üí¨ ËÅäÂ§©ËÆ∞ÂΩï: ${data.chat_history ? data.chat_history.length : 0} Êù°`, 'info');
                }
            } else {
                // Ê†áËÆ∞Ê≠•È™§ËøõË°å‰∏≠
                document.getElementById(`step${step}`).className = 'step active';
                addMessage(`Ê≠•È™§${step}`, `‚è≥ ${message}`, 'info');
            }
        }

        function handleComplete(data) {
            // Ê†áËÆ∞Á¨¨3Ê≠•ÂÆåÊàê
            document.getElementById('step3').className = 'step completed';
            addMessage('ÂÆåÊàê', `üéâ ${data.message}`, 'success');
            
            // ‰øùÂ≠òÂΩìÂâçËÅäÂ§©ÂÆ§‰ø°ÊÅØ
            currentChatroom = data.chatroom_id;
            targetUserId = parseInt(document.getElementById('targetUserIdInput').value);
            
            // ÂêØÁî®ËÅäÂ§©Á™óÂè£
            enableChatWindow(data);
            
            // ÊòæÁ§∫ËÅäÂ§©ÂéÜÂè≤
            if (data.chat_history && data.chat_history.length > 0) {
                displayChatHistory(data.chat_history);
                displayChatInWindow(data.chat_history);
            }

            // ÊòæÁ§∫ÊµãËØïÁªìÊûúÊ±áÊÄª
            displayTestResults();

            // ÈáçÊñ∞ÂêØÁî®ÊåâÈíÆ
            document.getElementById('startPrivateChatBtn').disabled = false;
        }

        function handleError(data) {
            const step = data.step || 'Êú™Áü•';
            const error = data.error;
            
            addMessage('ÈîôËØØ', `‚ùå Ê≠•È™§${step}: ${error}`, 'error');
            
            // ËÆ∞ÂΩïÈîôËØØ
            testResults.push({
                step: step,
                status: 'Â§±Ë¥•',
                message: error,
                data: data
            });

            // ÈáçÊñ∞ÂêØÁî®ÊåâÈíÆ
            document.getElementById('startPrivateChatBtn').disabled = false;
            
            // ÊòæÁ§∫ÊµãËØïÁªìÊûú
            displayTestResults();
        }

        function displayChatHistory(chatHistory) {
            const chatHistoryDiv = document.getElementById('chatHistory');
            chatHistoryDiv.innerHTML = '';
            
            if (chatHistory.length === 0) {
                chatHistoryDiv.innerHTML = '<div class="status info">ÊöÇÊó†ËÅäÂ§©ËÆ∞ÂΩï</div>';
            } else {
                chatHistory.forEach(msg => {
                    const [message, datetime, senderId, senderName] = msg;
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-message ${senderName === 'I' ? 'self' : 'other'}`;
                    
                    messageDiv.innerHTML = `
                        <div class="sender">${senderName} (ID: ${senderId})</div>
                        <div>${message}</div>
                        <div class="time">${datetime}</div>
                    `;
                    
                    chatHistoryDiv.appendChild(messageDiv);
                });
            }
            
            document.getElementById('chatHistorySection').style.display = 'block';
        }

        function displayTestResults() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';

            if (testResults.length === 0) {
                resultsDiv.innerHTML = '<div class="status info">ÊöÇÊó†ÊµãËØïÁªìÊûú</div>';
                return;
            }

            testResults.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = `status ${result.status === 'ÊàêÂäü' ? 'success' : 'error'}`;
                resultDiv.innerHTML = `
                    <strong>Ê≠•È™§${result.step}:</strong> ${result.status} - ${result.message}
                `;
                resultsDiv.appendChild(resultDiv);
            });

            // Ê∑ªÂä†ÊÄªÁªì
            const successCount = testResults.filter(r => r.status === 'ÊàêÂäü').length;
            const totalCount = testResults.length;
            const summaryDiv = document.createElement('div');
            summaryDiv.className = `status ${successCount === totalCount ? 'success' : 'error'}`;
            summaryDiv.innerHTML = `
                <strong>ÊµãËØïÊÄªÁªì:</strong> ${successCount}/${totalCount} ‰∏™Ê≠•È™§ÊàêÂäüÂÆåÊàê
            `;
            resultsDiv.appendChild(summaryDiv);
        }

        async function loadMatchList(userId) {
            try {
                addMessage('Á≥ªÁªü', 'üîÑ Ê≠£Âú®‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÁúüÂÆûÂåπÈÖçÂàóË°®...', 'info');
                
                // È¶ñÂÖàÈúÄË¶ÅËé∑ÂèñÁî®Êà∑ÁöÑmatch_idsÔºåÁÑ∂ÂêéÈÄê‰∏ÄËé∑ÂèñÂåπÈÖç‰ø°ÊÅØ
                // Áî±‰∫éÊ≤°ÊúâÁõ¥Êé•ÁöÑËé∑ÂèñÁî®Êà∑ÂåπÈÖçÂàóË°®ÁöÑAPIÔºåÊàë‰ª¨ÈúÄË¶ÅÈÄöËøáÁî®Êà∑‰ø°ÊÅØËé∑Âèñmatch_ids
                const userInfoResponse = await fetch('http://localhost:8000/api/v1/UserManagement/get_user_info_with_user_id', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId
                    })
                });
                
                if (!userInfoResponse.ok) {
                    throw new Error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•');
                }
                
                const userInfo = await userInfoResponse.json();
                addMessage('Á≥ªÁªü', `üìã Áî®Êà∑‰ø°ÊÅØËé∑ÂèñÊàêÂäüÔºåmatch_ids: ${JSON.stringify(userInfo.match_ids)}`, 'info');
                
                const matchIds = userInfo.match_ids || [];
                if (matchIds.length === 0) {
                    displayMatchList([]);
                    addMessage('Á≥ªÁªü', '‚ö†Ô∏è ËØ•Áî®Êà∑ÊöÇÊó†ÂåπÈÖçËÆ∞ÂΩï', 'info');
                    return;
                }
                
                // ÈÄê‰∏ÄËé∑ÂèñÊØè‰∏™ÂåπÈÖçÁöÑËØ¶ÁªÜ‰ø°ÊÅØ
                const matches = [];
                for (const matchId of matchIds) {
                    try {
                        const matchInfoResponse = await fetch('http://localhost:8000/api/v1/MatchManager/get_match_info', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                user_id: userId,
                                match_id: matchId
                            })
                        });
                        
                        if (matchInfoResponse.ok) {
                            const matchInfo = await matchInfoResponse.json();
                            
                            // Ëé∑ÂèñÁõÆÊ†áÁî®Êà∑ÁöÑÂêçÁß∞
                            const targetUserResponse = await fetch('http://localhost:8000/api/v1/UserManagement/get_user_info_with_user_id', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    user_id: matchInfo.target_user_id
                                })
                            });
                            
                            let targetUserName = `Áî®Êà∑${matchInfo.target_user_id}`;
                            if (targetUserResponse.ok) {
                                const targetUserInfo = await targetUserResponse.json();
                                targetUserName = targetUserInfo.telegram_user_name || targetUserName;
                            }
                            
                            matches.push({
                                match_id: matchId,
                                target_user_id: matchInfo.target_user_id,
                                target_user_name: targetUserName,
                                description_for_target: matchInfo.description_for_target,
                                is_liked: matchInfo.is_liked,
                                match_score: matchInfo.match_score,
                                chatroom_id: matchInfo.chatroom_id
                            });
                            
                            addMessage('Á≥ªÁªü', `‚úÖ ÂåπÈÖç ${matchId} ‰ø°ÊÅØÂä†ËΩΩÊàêÂäü`, 'info');
                        } else {
                            addMessage('Á≥ªÁªü', `‚ö†Ô∏è ÂåπÈÖç ${matchId} ‰ø°ÊÅØÂä†ËΩΩÂ§±Ë¥•`, 'error');
                        }
                    } catch (error) {
                        addMessage('Á≥ªÁªü', `‚ùå ÂåπÈÖç ${matchId} Âä†ËΩΩÂá∫Èîô: ${error.message}`, 'error');
                    }
                }
                
                displayMatchList(matches);
                addMessage('Á≥ªÁªü', `‚úÖ Â∑≤‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩ ${matches.length} ‰∏™ÁúüÂÆûÂåπÈÖç`, 'success');
                
            } catch (error) {
                console.error('Âä†ËΩΩÂåπÈÖçÂàóË°®Â§±Ë¥•:', error);
                addMessage('Á≥ªÁªü', `‚ùå Âä†ËΩΩÂåπÈÖçÂàóË°®Â§±Ë¥•: ${error.message}`, 'error');
                
                // ÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ‰ΩÜ‰∏çÈòªÂ°ûÊµãËØï
                document.getElementById('matchListSection').style.display = 'block';
                document.getElementById('matchList').innerHTML = `
                    <div class="status error">
                        Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÊâãÂä®ËæìÂÖ•ÂåπÈÖç‰ø°ÊÅØËøõË°åÊµãËØï<br>
                        ÈîôËØØ‰ø°ÊÅØ: ${error.message}
                    </div>
                `;
            }
        }
        
        function displayMatchList(matches) {
            const matchListDiv = document.getElementById('matchList');
            const matchListSection = document.getElementById('matchListSection');
            
            matchListDiv.innerHTML = '';
            
            if (matches.length === 0) {
                matchListDiv.innerHTML = '<div class="status info">ÊöÇÊó†ÂèØÁî®ÂåπÈÖç</div>';
            } else {
                matches.forEach(match => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match-item';
                    matchDiv.dataset.matchId = match.match_id;
                    matchDiv.dataset.targetUserId = match.target_user_id;
                    
                    matchDiv.innerHTML = `
                        <div class="match-header">
                            <div class="match-title">${match.target_user_name}</div>
                            <div class="match-score">ÂåπÈÖçÂ∫¶: ${match.match_score}%</div>
                        </div>
                        <div class="match-description">${match.description_for_target}</div>
                        <div class="match-info">
                            <div>ÂåπÈÖçID: ${match.match_id}</div>
                            <div class="match-status">
                                ${match.is_liked ? '<span class="status-badge liked">Â∑≤ÁÇπËµû</span>' : ''}
                                ${match.chatroom_id ? '<span class="status-badge chatroom">ÊúâËÅäÂ§©ÂÆ§</span>' : ''}
                            </div>
                        </div>
                    `;
                    
                    matchDiv.onclick = function() {
                        selectMatch(match);
                    };
                    
                    matchListDiv.appendChild(matchDiv);
                });
            }
            
            matchListSection.style.display = 'block';
        }
        
        function selectMatch(match) {
            // Ê∏ÖÈô§‰πãÂâçÁöÑÈÄâÊã©
            document.querySelectorAll('.match-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // ÈÄâÊã©ÂΩìÂâçÂåπÈÖç
            const matchElement = document.querySelector(`[data-match-id="${match.match_id}"]`);
            if (matchElement) {
                matchElement.classList.add('selected');
            }
            
            // Ëá™Âä®Â°´ÂÖÖË°®Âçï
            document.getElementById('targetUserIdInput').value = match.target_user_id;
            document.getElementById('matchIdInput').value = match.match_id;
            
            addMessage('ÈÄâÊã©', `‚úÖ Â∑≤ÈÄâÊã©ÂåπÈÖç: ${match.target_user_name} (ÂåπÈÖçID: ${match.match_id})`, 'success');
        }

        function addMessage(sender, content, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            const timestamp = new Date().toLocaleTimeString();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `
                <span class="timestamp">${timestamp}</span>
                <strong>[${sender}]</strong> ${content}
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function resetSteps() {
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`step${i}`).className = 'step';
            }
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÁöÑÊèêÁ§∫
        window.onload = function() {
            addMessage('Á≥ªÁªü', 'üëã Ê¨¢Ëøé‰ΩøÁî®ÁßÅ‰ø°ÊµÅÁ®ãÊµãËØïÈ°µÈù¢ÔºÅËØ∑ÂÖàËøûÊé•WebSocket„ÄÇ', 'info');
        };

        // ÂêØÁî®ËÅäÂ§©Á™óÂè£
        function enableChatWindow(data) {
            const chatWindow = document.getElementById('chatWindow');
            const chatTitle = document.getElementById('chatTitle');
            const chatStatus = document.getElementById('chatStatus');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            // ÂêØÁî®ËÅäÂ§©Á™óÂè£
            chatWindow.classList.remove('disabled');
            
            // ËÆæÁΩÆËÅäÂ§©Ê†áÈ¢ò
            const targetUserName = document.querySelector('.match-item.selected .match-title')?.textContent || `Áî®Êà∑${targetUserId}`;
            chatTitle.textContent = `‰∏é ${targetUserName} ÁöÑÁßÅ‰ø° (ËÅäÂ§©ÂÆ§: ${currentChatroom})`;
            
            // ËÆæÁΩÆÁä∂ÊÄÅ
            chatStatus.textContent = 'Â∑≤ËøûÊé•';
            
            // ÂêØÁî®ËæìÂÖ•Êéß‰ª∂
            messageInput.disabled = false;
            sendBtn.disabled = false;
            
            addMessage('ËÅäÂ§©', 'üí¨ ËÅäÂ§©Á™óÂè£Â∑≤ÂêØÁî®ÔºåÂèØ‰ª•ÂºÄÂßãÂèëÈÄÅÊ∂àÊÅØÔºÅ', 'success');
        }

        // Âú®ËÅäÂ§©Á™óÂè£‰∏≠ÊòæÁ§∫ËÅäÂ§©ÂéÜÂè≤
        function displayChatInWindow(chatHistory) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Ê∏ÖÁ©∫Áé∞ÊúâÂÜÖÂÆπ
            chatMessages.innerHTML = '';
            
            if (chatHistory.length === 0) {
                chatMessages.innerHTML = '<div class="empty-chat">üí¨ ÂºÄÂßã‰Ω†‰ª¨ÁöÑÂØπËØùÂêß...</div>';
            } else {
                chatHistory.forEach(msg => {
                    const [message, datetime, senderId, senderName] = msg;
                    addChatMessage(message, senderId === userId, senderName, datetime);
                });
            }
        }

        // Ê∑ªÂä†ËÅäÂ§©Ê∂àÊÅØÂà∞Á™óÂè£
        function addChatMessage(message, isSent, senderName, timestamp) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Â¶ÇÊûúÊòØÁ¨¨‰∏ÄÊù°Ê∂àÊÅØÔºåÊ∏ÖÈô§Á©∫ÁôΩÊèêÁ§∫
            const emptyChat = chatMessages.querySelector('.empty-chat');
            if (emptyChat) {
                emptyChat.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `real-chat-message ${isSent ? 'sent' : 'received'}`;
            
            const displayTime = timestamp || new Date().toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div>${message}</div>
                <div class="message-info">${displayTime} ${isSent ? '' : '‚Ä¢ ' + senderName}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // ÂèëÈÄÅÊ∂àÊÅØ
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                return;
            }
            
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                alert('WebSocketÊú™ËøûÊé•');
                return;
            }
            
            if (!targetUserId) {
                alert('ËØ∑ÂÖàÂêØÂä®ÁßÅ‰ø°ÊµÅÁ®ã');
                return;
            }
            
            // ‰ΩøÁî®ÂêéÁ´ØÊîØÊåÅÁöÑprivateÊ∂àÊÅØÊ†ºÂºè
            const messageData = {
                type: 'private',
                target_user_id: targetUserId.toString(),
                content: message,
                timestamp: new Date().toISOString()
            };
            
            websocket.send(JSON.stringify(messageData));
            
            // Á´ãÂç≥Âú®ÁïåÈù¢‰∏äÊòæÁ§∫ÂèëÈÄÅÁöÑÊ∂àÊÅØÔºà‰πêËßÇÊõ¥Êñ∞Ôºâ
            addChatMessage(message, true, 'Êàë', null);
            addMessage('ÂèëÈÄÅ', `üì§ ÂèëÈÄÅÁßÅËÅäÊ∂àÊÅØ: ${message}`, 'info');
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            messageInput.value = '';
        }

        // Â§ÑÁêÜWebSocketÊî∂Âà∞ÁöÑÊñ∞Ê∂àÊÅØ
        async function handleIncomingMessage(data) {
            // Â§ÑÁêÜprivate_messageÊ†ºÂºèÁöÑÊ∂àÊÅØ
            if (data.type === 'private_message') {
                let senderName = `Áî®Êà∑${data.from}`;
                
                // Â∞ùËØïËé∑ÂèñÂèëÈÄÅËÄÖÁöÑÁúüÂÆûÂßìÂêç
                try {
                    const userResponse = await fetch('http://localhost:8000/api/v1/UserManagement/get_user_info_with_user_id', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: parseInt(data.from)
                        })
                    });
                    
                    if (userResponse.ok) {
                        const userInfo = await userResponse.json();
                        senderName = userInfo.telegram_user_name || senderName;
                    }
                } catch (error) {
                    console.log('Ëé∑ÂèñÁî®Êà∑ÂêçÂ§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§ÂêçÁß∞:', error);
                }
                
                const message = data.content;
                const timestamp = data.timestamp;
                
                // ÊòæÁ§∫Âú®ËÅäÂ§©Á™óÂè£‰∏≠
                addChatMessage(message, false, senderName, timestamp);
                addMessage('Êé•Êî∂', `üì® Êî∂Âà∞ÁßÅËÅäÊ∂àÊÅØ: ${message} (Êù•Ëá™: ${senderName})`, 'success');
            } else {
                // Â§ÑÁêÜÂÖ∂‰ªñÊ†ºÂºèÁöÑÊ∂àÊÅØÔºà‰øùÊåÅÂÖºÂÆπÊÄßÔºâ
                if (data.chatroom_id === currentChatroom || !data.chatroom_id) {
                    const senderName = data.sender_name || `Áî®Êà∑${data.sender_id}`;
                    const message = data.message || data.content;
                    const isFromSelf = data.sender_id === userId || data.from === userId;
                    
                    addChatMessage(message, isFromSelf, senderName, data.timestamp);
                    addMessage('Êé•Êî∂', `üì® Êî∂Âà∞Ê∂àÊÅØ: ${message}`, 'success');
                }
            }
        }

        // Â§ÑÁêÜÊ∂àÊÅØÂèëÈÄÅÁä∂ÊÄÅ
        function handleMessageStatus(data) {
            const delivered = data.delivered;
            const content = data.content;
            const targetUserId = data.target_user_id;
            
            if (delivered) {
                addMessage('Áä∂ÊÄÅ', `‚úÖ Ê∂àÊÅØÂ∑≤ÂèëÈÄÅÁªôÁî®Êà∑${targetUserId}: "${content}"`, 'success');
            } else {
                addMessage('Áä∂ÊÄÅ', `‚ùå Ê∂àÊÅØÂèëÈÄÅÂ§±Ë¥•ÁªôÁî®Êà∑${targetUserId}: "${content}"`, 'error');
            }
        }

        // ÁõëÂê¨EnterÈîÆÂèëÈÄÅÊ∂àÊÅØ
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        });
    </script>
</body>
</html>